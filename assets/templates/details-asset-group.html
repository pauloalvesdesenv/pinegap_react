{% extends 'base.html' %}
{% load pinegap_tags %}
{% block content %}

<style>
ul.ui-autocomplete {
  position: fixed;
  top: initial;
}
.table-sum>tbody>tr>td, .table-sum>thead>tr>th { padding: 1px; }
.table-sum>tbody>tr>td.ct{ text-align: center; }

.row.finding-stats > div {
  margin: 0;
  padding: 2px;
}

span.badge-risk-grade-A { background-color: limegreen; }
span.badge-risk-grade-B { background-color: yellowgreen; }
span.badge-risk-grade-C { background-color: orange; }
span.badge-risk-grade-D { background-color: darkorange; }
span.badge-risk-grade-E { background-color: orangered; }
span.badge-risk-grade-F { background-color: red; }
span.badge-risk-grade-- { background-color: lightgray; }

div.risk-grade { font-size: xx-large; padding: 10px; border-radius: 5px; }
div.risk-grade-A { background-color: limegreen; }
div.risk-grade-B { background-color: yellowgreen; }
div.risk-grade-C { background-color: orange; }
div.risk-grade-D { background-color: darkorange; }
div.risk-grade-E { background-color: orangered; }
div.risk-grade-F { background-color: red; }

div.tile {
  border-width: thin;
  border-style: solid;
  border-left-width: 1rem;
  border-radius: 3px;
  padding-bottom: 15px;
  text-align: center;
}
div.tile div { font-size: large; }
div.tile-critical { border-color: #cc0500; }
div.tile-high { border-color: #df3d03; }
div.tile-medium { border-color: #f9a009; }
div.tile-low { border-color: #ffcb0d; }
div.tile-info { border-color: #3498db; }

div.risk-trends {
  border-top-color: lightgray;
  border-top-style: solid;
}

.row {
    margin-left: -15px;
    margin-right: 15px;
}

</style>
<div class="container-fluid" asset-id="{{asset_group.id|safe}}" style="padding:0;">
      <section class="content-header">
      <h1>
      Ativos
      <small>Detalhes do Grupo de Ativos</small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="/assets/list"><i class="fas fa-crosshairs"></i> Ativos</a></li>
        <li class="active"> Detalhes do Grupo de Ativos</li>
      </ol>
      </section>
      <div class="container-fluid" style="padding:15px 15px; padding-bottom:0;">

	<div class="nav-tabs-custom">
	<ul class="nav nav-tabs">
              <li class="dropdown">
			<a class="dropdown-toggle" data-toggle="dropdown" href="/assets/list">
			<i class="fas fa-crosshairs"></i>&nbsp; Ativos <span class="caret"></span>
			</a>
			<ul class="dropdown-menu">
				<li role="presentation"><a role="menuitem" href="/assets/list"><i class="fa fa-list"></i> Todos os Ativos</a></li>
				{% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
				<li role="presentation"><a role="menuitem" href="/assets/add"><i class="fa fa-plus"></i>&nbsp; Criar Ativo</a></li>
				<li role="presentation"><a role="menuitem" href="/assets/bulkadd"><i class="fa fa-upload"></i> Importar Ativos</a></li>
				<li role="presentation"><a role="menuitem" href="/assets/api/v1/export"><i class="fa fa-download"></i> Exportar Ativos</a></li>
		                {% endif %}
			        </ul>
			        </li>
                                <li class="active dropdown">
				<a class="dropdown-toggle" data-toggle="dropdown" href="/assets/list?target=asset_group">
		         	<i class="fa fa-th-list"></i>&nbsp; Grupos de Ativos <span class="caret"></span>
				</a>
				<ul class="dropdown-menu">
				<li role="presentation"><a role="menuitem" href="/assets/list?target=asset_group"><i class="fa fa-list"></i> Todos os Grupos de Ativos</a></li>
                                {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
                		<li role="presentation"><a role="menuitem" href="/assets/addgroup"><i class="fa fa-plus"></i> &nbsp; Criar Grupo de Ativos</a></li>
                                <li role="presentation"><a role="menuitem" href="{% url 'export_assetgroups_api' %}"><i class="fa fa-download"></i> Exportar Grupos de Ativos</a></li>
                                {% endif %}
                 		</ul>
			        </li>
                                <li class="dropdown">
				<a class="dropdown-toggle" data-toggle="dropdown" href="/assets/owners/list">
				<i class="fa fa-user-secret"></i>&nbsp; Proprietários <span class="caret"></span>
				</a>
				<ul class="dropdown-menu">
				<li role="presentation"><a role="menuitem" href="/assets/owners/list"><i class="fa fa-list"></i> Todos os Proprietários</a></li>
                                {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
				<li role="presentation"><a role="menuitem" href="/assets/owners/add"><i class="fa fa-plus"></i>&nbsp; Criar Proprietário</a></li>
                                {% endif %}
            		     </ul>
			</li>
           	   </ul>
  <div class="tab-content">

  <div class="row detail-box">
    <div class="col-md-4">
		<h5><span class="fa fa-database"></span>&nbsp; Dados do Ativo</h5>
		<table class="table table-bordered details-table">
			<tr>
				<td style="text-align:right; font-weight:bolder;">Nome</td>
				<td>{{ asset_group.name }}</td>
			</tr>
			<tr>
				<td style="text-align:right; font-weight:bolder;">Descrição</td>
				<td>{{ asset_group.description }}</td>
			</tr>
			<tr>
				<td style="text-align:right; font-weight:bolder;">Tags</td>
				<td>
				{% for tag in asset_group.categories.all %}
				<span class="label label-primary">{{tag.value|lower}} <i class="glyphicon glyphicon-remove text-warning delete-tag-btn" tag-id="{{tag.id|safe}}"></i></span>
				{% endfor %}
				<a class="label label-default"  href="#modal-edit-asset-group-tags" data-toggle="modal" data-target="#modal-edit-asset-group-tags">+ adicionar</a>
				</td>
			</tr>
			<tr>
				<td style="text-align:right; font-weight:bolder;">Criticidade</td>
				<td>
					{% if asset_group.criticity == 'low' %}
					<span class="label label-low">baixa</span>
					{% elif asset_group.criticity == 'medium' %}
					<span class="label label-medium">m&eacute;dia</span>
					{% elif asset_group.criticity == 'high' %}
					<span class="label label-critical">Alta</span>
					{% endif %}
				</td>
			</tr>
			<tr>
				<td style="text-align:right; font-weight:bolder;">Criado</td>
				<td>{{ asset_group.created_at|date:"d/m/Y\-H:i:s" }}</td>
			</tr>
			<tr>
				<td style="text-align:right; font-weight:bolder;">Baixar Relatório</td>
				<td>
					<a class="label label-low" target="_blank" href="/assets/api/v1/groups/report/json/{{ asset_group.id|safe }}">json</a> -
					<a class="label label-low" target="_blank" href="/assets/groups/report/{{ asset_group.id|safe }}">html</a>
				</td>
			</tr>
			<tr>
				<td style="text-align:right; font-weight:bolder;">Exportar Ativos</td>
				<td><a class="label label-default" href="{% url 'export_assets_api' asset_group.id|safe %}">CSV</a></td>
			</tr>
		</table>

    </div><!-- End of first col -->

    <div class="col-md-6 tiles"> <!-- Second col -->
      <div class="row">
        <h5><span class="glyphicon glyphicon-stats"></span> &nbsp;Estat&iacute;sticas de Ocorr&ecirc;ncias </h5>
      </div>
      <div class="row finding-stats">
        <div class="col-md-2">
          <div class="tile tile-critical">
              <div>Cr&iacute;tica</div><span class="label label-critical">{{findings_stats.critical}}</span>
          </div>
        </div>
        <div class="col-md-2">
          <div class="tile tile-high">
              <div>Alta</div><span class="label label-high">{{findings_stats.high}}</span>
          </div>
        </div>
        <div class="col-md-2">
          <div class="tile tile-medium">
              <div>M&eacute;dia</div><span class="label label-medium">{{findings_stats.medium}}</span>
          </div>
        </div>
        <div class="col-md-2">
          <div class="tile tile-low">
              <div>Baixa</div><span class="label label-low">{{findings_stats.low}}</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="tile tile-info">
              <div>Desconhecida</div><span class="label label-info">{{findings_stats.info}}</span>
          </div>
        </div>
      </div>
      <div class="row">
        <div style="margin-top:20px;">
			<table class="table table-bordered details-table">
				<tr>
					<td style="text-align:right; font-weight:bolder;"># Ocorr&ecirc;ncias</td>
					<td><i>{{findings_stats.total}} ({{findings_stats.new}} novas, {{findings_stats.ack}} ignoradas.)</i></td>
				</tr>
				<tr>
					<td style="text-align:right; font-weight:bolder;"># Scans relacionados</td>
					<td><i>{{scans_stats.performed}} realizado, {{scans_stats.defined}} definido, {{scans_stats.running}} executando</i></td>
				</tr>
				<tr>
					<td style="text-align:right; font-weight:bolder;"># Scans do sensor</td>
					<td>
						<i>
						{% for engine, counter in engines_stats.items %}
							{{ engine }}: {{ counter }}{% if not forloop.last %}, {% endif %}
						{% endfor %}
						</i>
					</td>
				</tr>
			</table>

      	</div>
      </div>
    </div>

    <div class="col-md-2 text-center"> <!-- Thrird col -->
      <div class="row">
        <i class="fa fa-globe"></i> &nbsp;Nota de Segurança &nbsp;
        <div class="risk-grade risk-grade-{{asset_group_risk_grade|keyvalue:'now'}}">
          <b>{{asset_group_risk_grade|keyvalue:"now"}}</b></div>
        </div><br/>
      <div class="row risk-trends">
      <b>Tend&ecirc;ncias  </b><span class="glyphicon glyphicon-time"></span>
      </div>
      <div class="row">
        <div class="col-md-4" title="1 day ago">-1dia
          {% if asset_group_risk_grade|keyvalue:"now" > asset_group_risk_grade|keyvalue:"day_ago" %}
          <span class="glyphicon glyphicon-arrow-down text-danger"></span>
          {% elif asset_group_risk_grade|keyvalue:"now" == asset_group_risk_grade|keyvalue:"day_ago" %}
          <span class="glyphicon glyphicon-minus"></span>
          {% else %}
          <span class="glyphicon glyphicon-arrow-up text-success"></span>
          {% endif %}
        </div>
        <div class="col-md-4">-1sem
          {% if asset_group_risk_grade|keyvalue:"now" > asset_group_risk_grade|keyvalue:"week_ago" %}
          <span class="glyphicon glyphicon-arrow-down text-danger"></span>
          {% elif asset_group_risk_grade|keyvalue:"now" == asset_group_risk_grade|keyvalue:"week_ago" %}
          <span class="glyphicon glyphicon-minus"></span>
          {% else %}
          <span class="glyphicon glyphicon-arrow-up text-success"></span>
          {% endif %}
        </div>
        <div class="col-md-4">-1m&ecirc;s
          {% if asset_group_risk_grade|keyvalue:"now" > asset_group_risk_grade|keyvalue:"month_ago" %}
          <span class="glyphicon glyphicon-arrow-down text-danger"></span>
          {% elif asset_group_risk_grade|keyvalue:"now" == asset_group_risk_grade|keyvalue:"month_ago" %}
          <span class="glyphicon glyphicon-minus"></span>
          {% else %}
          <span class="glyphicon glyphicon-arrow-up text-success"></span>
          {% endif %}
        </div>
      </div>
    </div>
  </div><!-- End of row -->


<div class="container-fluid">
  <div class="row">
    <div class="col-md-11">
      <!-- <h4>Quick report</h4> -->
      <p>
        {% for scope, counter in asset_scopes %}
          <a href="/findings/list?_scope={{ counter.id|safe }}&_asset_group_id={{ asset_group.id|safe }}" style="text-decoration:none;">
          {% if counter.critical > 0 %}
          <span class="label label-critical">{{ scope }}: {{ counter.critical }}/{{ counter.total }}</span>
          {% elif counter.high > 0 %}
          <span class="label label-high">{{ scope }}: {{ counter.high }}/{{ counter.total }}</span>
          {% elif counter.medium > 0 %}
          <span class="label label-medium">{{ scope }}: {{ counter.medium }}/{{ counter.total }}</span>
          {% elif counter.low > 0 %}
          <span class="label label-low">{{ scope }}: {{ counter.low }}/{{ counter.total }}</span>
          {% else %}
          <span class="label label-info">{{ scope }}: {{ counter.total }}</span>
          {% endif %}
          </a>
        {% endfor %}
        <a class="label label-low" href="#" data-toggle="modal" style="color:#333 !important;" data-target="#modal-scopes-details">+ detalhes</a>
      </p>
    </div>
  </div>
</div>
</div>
</div>
</div>
<div class="container-fluid details-tab" style="padding-top:0;">
<div class="nav-tabs-custom">
  <ul class="nav nav-tabs" id="menu_tabs_ul">
    <li class="active menu_assets"><a data-toggle="tab"  href="#assets_div">Ativos</a></li>
    <li class="menu_findings"><a data-toggle="tab"  href="#findings_div">Ocorr&ecirc;ncias</a></li>
    <li class="menu_remediations"><a data-toggle="tab" href="#remediations_div">Remedia&ccedil;&atilde;o</a></li>
    <li class="menu_scans"><a data-toggle="tab" href="#scans_div">Scans</a></li>
    <li class="menu_owners"><a data-toggle="tab" href="#owners_div">Propriet&aacuterios</a></li>
    <li class="menu_alerts"><a data-toggle="tab" href="#alerts_div">Alertas</a></li>
    <li class="menu_comments"><a data-toggle="tab" href="#comments_div">Coment&aacute;rios</a></li>
  </ul>
  <div class="tab-content">
    <div id="assets_div" class="tab-pane fade in active">

      <table class="table table-bordered" data-toggle="table" data-sort-name="value" data-sort-order="desc">
        <thead>
          <tr>
            <th><input type="checkbox" onClick="toggle(this, 'asset')" /></th>
            <th data-field="name">Nome</th>
            <th data-field="findings_summary">Resumo das Ocorr&ecirc;ncias</th>
            <th data-field="criticity">Criticidade</th>
            <th data-field="score">Score</th>
            <th data-field="type">Tipo</th>
            <th data-field="updated_at">Atualizado</th>
            {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
            <th data-field="actions">A&ccedil;&otilde;es</th>
    	    {% endif %}
	   </tr>
        </thead>
        <tbody>
          {% for asset in asset_group.assets.all %}
          <tr class='dblclickable-row' data-href='/assets/details/{{ asset.id|safe }}'>
            <td><input type="checkbox" class="radio" name="asset" value="{{ asset.id|safe }}"/></td>
            <td><a href="/assets/details/{{ asset.id|safe }}">{{ asset.name }} ({{ asset.value }})</a></td>
            <td>
              {% if asset.risk_level.critical > 0 %}
                <span class="label label-critical">{{ asset.risk_level.critical }}</span>
              {% else %}
                0
              {% endif %}/
              {% if asset.risk_level.high > 0 %}
                <span class="label label-high">{{ asset.risk_level.high }}</span>
              {% else %}
                0
              {% endif %}/
              {% if asset.risk_level.medium > 0 %}
                <span class="label label-medium">{{ asset.risk_level.medium }}</span>
              {% else %}
                0
              {% endif %}/
              {% if asset.risk_level.low > 0 %}
                <span class="label label-low">{{ asset.risk_level.low }}</span>
              {% else %}
                0
              {% endif %}/
              {% if asset.risk_level.info > 0 %}
                <span class="label label-info">{{ asset.risk_level.info }}</span>
              {% else %}
                0
              {% endif %}
            </td>
            {% if asset.criticity == 'low' %}
            <td><span class="label label-info">Baixa</span></td>
            {% elif asset.criticity == 'medium' %}
            <td><span class="label label-medium">M&eacute;dia</span></td>
            {% elif asset.criticity == 'high' %}
            <td><span class="label label-critical">Alta</span></td>
            {% endif %}
            <td><span class="badge badge-risk-grade-{{ asset.get_risk_grade }}">{{ asset.get_risk_grade }}</span></td>
            <td>{{ asset.type }}</td>
            <td>{{ asset.updated_at|date:"d/m/Y\-H:i:s" }}</td>
            {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
            <td>
              <button type="button" class="btn btn-default btn-xs" aria-haspopup="true" aria-expanded="false" onclick="location.href='/assets/details/{{ asset.id|safe }}'">
                <span class="glyphicon glyphicon-eye-open"></span></button>
              <button type="button" class="btn btn-warning btn-xs" aria-haspopup="true" aria-expanded="false" onclick="location.href='/assets/edit/{{ asset.id|safe }}'">
                <span class="glyphicon glyphicon-pencil"></span></button>
              <button type="button" class="btn btn-danger btn-xs" data-toggle="modal" data-target="#modal-delete-asset"
                 asset-id="{{ asset.id|safe }}" asset-value="{{ asset.value }}">
                 <span class="glyphicon glyphicon-remove"></span></button>
            </td>
	    {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="findings_div" class="tab-pane fade">
      <div class="dropdown">
        <button class="btn btn-primary btn-xs dropdown-toggle" type="button" id="dropdown-menu-actions" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
          A&ccedil;&otilde;es
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdown-menu-actions">
          {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
          <li><a class="btn-ack" href="#">Ignorar Ocorr&ecirc;ncia(s) Selecionada(s)</a></li>
  	  {% endif %}
          <li><a class="btn-compare-selected" href="#">Comparar Ocorr&ecirc;ncia(s) Selecionada(s) (2 max.)</a></li>
          {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
	  <li><a class="btn-delete-selected" href="#">Excluir Ocorr&ecirc;ncia(s) Selecionada(s)</a></li>
	  {% endif %}
        </ul>
      </div>
      <table class="table table-bordered" id="table" data-toggle="table">
        <thead>
          <tr>
            <th><input type="checkbox" onClick="toggle(this, 'finding')" /></th>
            <th>Ativos</th>
            <th>Descrição da Ocorr&ecirc;ncia</th>
            <th>Tipo da Ocorr&ecirc;ncia</th>
            <th>Severidade</th>
            <th>Status</th>
            <th>Origem</th>
            <th>Atualizado</th>
            {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
            <th>A&ccedil;&otilde;es</th>
	    {% endif %}
          </tr>
        </thead>
        <tbody>
        {% for finding in findings %}
        <tr class='dblclickable-row' data-href='/findings/details/{{ finding.id|safe }}'>
          <td><input type="checkbox" class="radio" name="finding" value="{{ finding.id|safe }}"/></td>
          <td><a href="/assets/details/{{ finding.asset_id|safe }}">{{ finding.asset_name }}</a></td>
          <td>{{ finding.title }}</td>
          <td>{{ finding.type }}</td>
          <td>
            {% if finding.severity == 'critical' %}
            <span class="label label-critical">Crítica</span>
            {% elif finding.severity == 'high' %}
            <span class="label label-high">Alta</span>
            {% elif finding.severity == 'medium' or finding.severity == 'moderate' %}
            <span class="label label-medium">Média</span>
            {% elif finding.severity == 'low' %}
            <span class="label label-low">Baixa</span>
            {% else %}
            <span class="label label-info">Desconhecida</span>
            {% endif %}
            </td>
          {% if finding.status == 'new' %}
          <td class="text-danger">Nova</td>
          {% elif finding.status == 'ack' %}
          <td class="text-danger">Ignorada</td>
          {% elif finding.status == 'confirmed' %}
          <td>Confirmada</td>
          {% elif finding.status == 'mitigated' %}
          <td>Mitigada</td>
          {% elif finding.status == 'closed' %}
          <td>Encerrada</td>
          {% elif finding.status == 'patched' %}
          <td>Corrigida</td>
          {% elif finding.status == 'false-positive' %}
          <td>Falso-Positivo</td>
          {% endif %}
          <td>{{ finding.engine_type }}</td>
          <td>{{ finding.updated_at|date:"d/m/Y\-H:i:s" }}</td>
          {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
          <td>
            <div class="btn-toolbar btn-group">
              <a href="/findings/details/{{ finding.id|safe }}" class="btn btn-default btn-xs">
                <span class="glyphicon glyphicon-eye-open"></span></a>
                <a href="/findings/delete/{{ finding.id|safe }}" class="btn btn-danger btn-xs"
                data-toggle="modal" data-target="#modal-delete-finding"
                finding-id="{{ finding.id|safe }}" finding-title="{{ finding.title }}">
                <span class="glyphicon glyphicon-remove"></span></a>
            </div>
          </td>
	  {% endif %}
        </tr>
      {% endfor %}
      </tbody>
      </table>
    </div>
    <div id="remediations_div" class="tab-pane fade">
      <table class="table table-bordered" id="table" data-toggle="table">
        <thead>
          <tr>
            <th>Severidade</th>
            <th>Remedia&ccedil;&atilde;o</th>
            <th>Escopos</th>
            <th>Ocorr&ecirc;ncias relacionadas</th>
            <th>Status</th>
            <th>Atualizado</th>
          </tr>
        </thead>
        <tbody>
          {% for finding in findings %}
          {% if finding.severity != "info" %}
          <tr>
            <td>
              {% if finding.severity == 'critical' %}
              <span class="label label-critical">Crítica</span>
              {% elif finding.severity == 'high' %}
              <span class="label label-high">Alta</span>
              {% elif finding.severity == 'medium' or finding.severity == 'moderate' %}
              <span class="label label-medium">Média</span>
              {% elif finding.severity == 'low' %}
              <span class="label label-low">Baixa</span>
              {% else %}
              <span class="label label-info">Desconhecida</span>
              {% endif %}
            </td>
            <td>{{ finding.solution }}</td>
            <td>
              {# for scope in finding.scan.engine_policy.scopes.all #}
              {% for scope in finding.scope_list %}
              {{scope}}{% if not forloop.last %},{% endif %}
              {% endfor %}
            </td>
            <td><a href="/findings/details/{{ finding.id|safe }}">ID: {{ finding.id|safe }}</a></td>
            {% if finding.status == "confirmed" %}
            <td>Confirmada</td>
            {% elif finding.status == "ack" %}
            <td>Ignorada</td>
            {% elif finding.status == "new" %}
            <td>Nova</td>
            {% elif finding.status == "mitigated" %}
            <td>Mitigada</td>
            {% elif finding.status == "closed" %}
            <td>Encerrada</td>
            {% elif finding.status == "patched" %}
            <td>Corrigida</td>
            {% elif finding.status == "false-positive" %}
            <td>Falso-Positivo</td>
            {% endif %}
            <td>{{ finding.updated_at|date:"d/m/Y\-H:i:s" }}</td>
          </tr>
         {% endif %}
         {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="scans_div" class="tab-pane fade">
      <h5>Defini&ccedil;&otilde;es de Scan {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}<a class="label label-low" href="/scans/defs/add?asset_group_id={{asset_group.id|safe}}#notsupported">+ adicionar nova</a>{% endif %}</h5>
      <table class="table table-bordered" id="table" data-toggle="table">
        <thead>
          <tr>
            <th><input type="checkbox" onClick="toggle(this, 'scan_defs')" /></th>
            <th>ID do Scan</th>
            <th># Scans</th>
            <th>Tipo</th>
            <th>Sensor</th>
            <th>Status</th>
            <th>Atualizado</th>
            {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
            <th>A&ccedil;&otilde;es</th>
	    {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for scan_def in scan_defs %}
          <tr>
            <td><input type="checkbox" class="radio" name="scan_defs" value="{{ scan_def.id|safe }}"/></td>
            <td><a href="/scans/defs/details/{{ scan_def.id|safe }}" class="text-primary">{{ scan_def.id|safe }}</a></td>
            <td>{{ scan_def.scan_set.count }}</td>
            {% if scan_def.scan_type == "periodic" %}
            <td>Recorrente/Automático</td>
            {% elif scan_def.scan_type == "single" %}
            <td>Pontual/Manual</td>
            {% elif scan_def.scan_type == "scheduled" %}
            <td>Agendado/Hibrido</td>
            {% endif %}
            <td>{{ scan_def.engine_type_name }}</td>
            {% if scan_def.scan_type == "periodic" %}
            {% if scan_def.enabled %}
            <td><span class="label label-success">Habilitado</span></td>
            {% else %}
            <td><span class="label label-danger">Desabilitado</span></td>
            {% endif %}
            {% elif scan_def.scan_type == "single" %}
            <td><span class="label label-default">Pronto</span></td>
            {% elif scan_def.scan_type == "scheduled" %}
            <td><span class="label label-info">Agendado</span></td>
            {% endif %}
            <td>{{ scan_def.updated_at|date:"d/m/Y\-H:i:s" }}</td>
            {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
            <td>
              <button type="button" class="btn btn-default btn-xs" aria-haspopup="true" aria-expanded="false" onclick="location.href='/scans/defs/edit/{{ scan_def.id|safe }}'">
                <span class="glyphicon glyphicon-edit"></span></button>
                {% if scan_def.scan_type == "periodic" %}
                {% if scan_def.enabled %}
                <button type="button" class="btn btn-warning btn-xs btn-change-status" aria-haspopup="true" aria-expanded="false" scan-id="{{ scan_def.id|safe }}">
                  Desabilitar</button>
                {% else %}
                <button type="button" class="btn btn-success btn-xs btn-change-status" aria-haspopup="true" aria-expanded="false" scan-id="{{ scan_def.id|safe }}">
                  Habilitar</button>
                {% endif %}
              {% elif scan_def.scan_type == "single" %}
                <button type="button" class="btn btn-warning btn-xs btn-run-now" scan-id="{{ scan_def.id|safe }}" scan-title="{{ scan_def.title }}" data-toggle="modal" data-target="#modal-run-scan">
                  Executar </button>
              {% endif %}
                <button type="button" class="btn btn-danger btn-xs" data-toggle="modal" data-target="#modal-delete-scan-def"
                scan-id="{{ scan_def.id|safe }}" scan-title="{{ scan_def.title }}">
                <span class="glyphicon glyphicon-remove"></button>
            </td>
	   {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <hr>

      <h5>Scans realizados</h5>
      <table class="table table-bordered" id="table" data-toggle="table">
        <thead>
          <tr>
            <th data-field="cb"><input type="checkbox" onClick="toggle(this, 'scan')" /></th>
            <th data-field="title">Nome</th>
            <th data-field="title">Sensor</th>
            <th data-field="title">Scan ID</th>
            <th data-field="status">Status</th>
            <th data-field="progress" style="width:20%">Progresso</th>
            <th data-field="started_at">Iniciado</th>
            <th data-field="finished_at">Finalizado</th>
            <th data-field="updated_at">Atualizado</th>
            {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %}
            <th data-field="actions">A&ccedil;&otilde;es</th>
	    {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for scan in scans %}
            <tr class='dblclickable-row' data-href='/scans/details/{{scan.id|safe}}'>
              <td><input type="checkbox" class="radio" name="scan" value="{{ scan.id|safe }}"/></td>
              <td>{{ scan.title }}</td>
              <td>{{ scan_def.engine_type_name }}</td>
              <td>{{ scan.id|safe }}</td>
              {% if scan.status == "started" %}
              <td class="text-center"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate" style="color:orange" title="Iniciado"></span></td>
              {% elif scan.status == "stopping"  %}
              <td class="text-center"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate" style="color:red" title="Parando"></span></td>
              {% elif scan.status == "stopped"  %}
              <td class="text-center"><span class="glyphicon glyphicon-remove" style="color:red" title="Parado"></span></td>
              {% elif scan.status == "finished"  %}
              <td class="text-center"><span class="glyphicon glyphicon-ok" style="color:green" title="Finalizado"></span></td>
              {% elif scan.status == "scheduled"  %}
              <td class="text-center"><span class="glyphicon glyphicon-time" style="color:blue" title="Agendado"></span></td>
              {% elif scan.status == "enqueued"  %}
              <td class="text-center"><span class="glyphicon glyphicon-pushpin" style="color:orange" title="Na fila"></span></td>
              {% elif scan.status == "error"  %}
              <td class="text-center"><span class="glyphicon glyphicon-fire" style="color:red" title="Error"></span></td>
              {% else %}
              <td>{{ scan.status }}</td>
              {% endif %}

              <td class="scan-progress">
                <div class="progress" id="pb-{{ scan.id|safe }}">
                  {% if scan.status == "finished" %}
                  <div class="progress-bar progress-bar progress-bar-critical" role="progressbar" style="width:{{ scan.summary.critical | perc:scan.summary.total }}%">
                    {{ scan.summary.critical }}
                  </div>
                  <div class="progress-bar progress-bar progress-bar-high" role="progressbar" style="width:{{ scan.summary.high | perc:scan.summary.total }}%">
                    {{ scan.summary.high }}
                  </div>
                  <div class="progress-bar progress-barprogress-bar-medium" role="progressbar" style="width:{{ scan.summary.medium | perc:scan.summary.total }}%">
                    {{ scan.summary.medium }}
                  </div>
                  <div class="progress-bar progress-bar progress-bar-low" role="progressbar" style="width:{{ scan.summary.low | perc:scan.summary.total }}%">
                    {{ scan.summary.low }}
                  </div>
                  <div class="progress-bar progress-bar progress-bar-info" role="progressbar" style="width:{{ scan.summary.info | perc:scan.summary.total }}%">
                    {{ scan.summary.info }}
                  </div>
                  {% else %}
                  <div class="progress-bar progress-bar-striped active" role="progressbar">
                    -
                  </div>
                  {% endif %}
                </div>
              </td>
              <td>{{ scan.started_at|date:"d/m/Y\-H:i:s" }}</td>
              <td>{{ scan.finished_at|date:"d/m/Y\-H:i:s" }}</td>
              <td>{{ scan.updated_at|date:"d/m/Y\-H:i:s" }}</td>
              {% if user.groups.all.0.name == 'root'  or  user.groups.all.0.name == 'gestor' %} 
              <td>
              <button type="button" class="btn btn-default btn-xs" title="Details" onclick="location.href='/scans/details/{{ scan.id|safe }}'">detalhes</button>
              {% if scan.status == "enqueued" or scan.status == "started" %}
              <button type="button" class="btn btn-danger btn-xs btn-stop-scan" title="Parar Scan" scan-id="{{ scan.id|safe }}">
              <span class="glyphicon glyphicon-stop" scan-id="{{ scan.id|safe }}"></span></button>
              {% else %}
              <button type="button" class="btn btn-default btn-xs" title="Exportar Ocorr&ecirc;ncias" onclick="location.href='/scans/api/v1/report/html/{{ scan.id|safe }}'">
              <span class="glyphicon glyphicon-share"></span></button>
              {% endif %}
              <button type="button" class="btn btn-warning btn-xs btn-run-now" scan-id="{{ scan.scan_definition__id|safe }}" scan-title="{{ scan.title }}" data-toggle="modal" data-target="#modal-run-scan">Run </button>
              <button type="button" class="btn btn-danger btn-xs" data-toggle="modal" data-target="#modal-delete-scan"
              scan-id="{{ scan.id|safe }}" scan-title="{{ scan.title }}">
              <span class="glyphicon glyphicon-remove"></button>
              </td>
	     {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="owners_div" class="tab-pane fade">
      Propriet&aacuterios<br/>
      .
    </div>
    <div id="alerts_div" class="tab-pane fade">
      Alertas<br/>
      .
    </div>
    <div id="comments_div" class="tab-pane fade">
      Coment&aacute;rios<br/>
      .
    </div>
  </div>
</div>

<div class="container">
  {% if messages %}
  <ul class="messages">
      {% for message in messages %}
      <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
  </ul>
  {% endif %}
</div>
</div>
</div>

<!-- Scope details modal -->
<div class="modal fade" id="modal-scopes-details" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header bg-primary">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Fechar</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Detalhes</h4>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <div id="scopes-details">
          <!-- Content -->
          <table class="table table-sum table-bordered">
            <thead>
              <tr>
                <th>Escopos</th>
                <th>Cr&iacute;tica</th>
                <th>Alta</th>
                <th>M&eacute;dia</th>
                <th>Baixa</th>
                <th>Info</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              {% for scope, counter in asset_scopes %}
              <tr>
                <td>{{scope}}</td>
                <td class="col-md-1 ct">
                  {% if counter.critical > 0 %}
                  <span class="label label-critical">{{counter.critical}}</span>
                  {% else %}
                  {{counter.critical}}
                  {% endif %}
                </td>
                <td class="col-md-1 ct">
                  {% if counter.high > 0 %}
                  <span class="label label-high">{{counter.high}}</span>
                  {% else %}
                  {{counter.high}}
                  {% endif %}
                </td>
                <td class="col-md-1 ct">
                  {% if counter.medium > 0 %}
                  <span class="label label-medium">{{counter.medium}}</span>
                  {% else %}
                  {{counter.medium}}
                  {% endif %}
                </td>
                <td class="col-md-1 ct">
                  {% if counter.low > 0 %}
                  <span class="label label-low">{{counter.low}}</span>
                  {% else %}
                  {{counter.low}}
                  {% endif %}
                </td>
                <td class="col-md-1 ct">{% if counter.info > 0 %}
                  <span class="label label-info">{{counter.info}}</span>
                  {% else %}
                  {{counter.info}}
                  {% endif %}
                </td>
                <td class="col-md-1 ct"><strong>{{counter.total}}</strong></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <button type="button" class="btn btn-xs btn-primary col-sm-12" data-dismiss="modal">Cancelar</button><br/>
      </div>
    </div>
  </div>
</div>

<!-- Delete finding modal -->
<div class="modal fade" id="modal-delete-finding" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header bg-primary">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Fechar</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Excluir Ocorr&ecirc;ncia</h4>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <div id="delete-finding">
          <!-- Content -->
        </div>
        Confirm Exclus&atilde;o?
        <button type="button" class="btn btn-xs btn-warning btn-delete-finding" data-dismiss="modal" autofocus>Sim</button>
        <button type="button" class="btn btn-xs btn-primary" data-dismiss="modal">N&atilde;o</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Asset Modal -->
<div class="modal fade" id="modal-edit-asset-group-tags" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header bg-primary">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Fechar</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Adicionar tags</h4>
      </div>

      <!-- Modal Body -->
      <!-- <div class="modal-body"> -->
      <div class="modal-body">
        <div id="asset-tags">
          <!-- Content -->
          <b>Tags Atuais</b>: {{ asset_group.categories.all|join:", " }}<br/>
          <p class="text-warning">
            CUIDADO: <br/>
            1/ Todas as sub-tags ser&atilde;o exclu&iacute;das se uma tag pai for adicionada<br/>
            2/ A tag pai ser&aacute; exclu&iacute;da se uma tag filha for adicionada</p>

          <form class="search-asset-group-tags-form" action="/assets/api/v1/groups/details/{{asset_group.id|safe}}/add_tag" method="post">
            {% csrf_token %}
            <input type="text" id="input-search-tags" name="input-search-tags"/><button class="btn btn-xs btn-warning" type="submit">+</button>
          </form>

        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-xs btn-default" data-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Asset modal -->
  <div class="modal fade" id="modal-delete-asset" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header bg-primary">
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
            <span class="sr-only">Fechar</span>
          </button>
          <h4 class="modal-title" id="myModalLabel">Excluir Ativo</h4>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <div id="delete-asset">
            <!-- Content -->
          </div>
          Confirma Exclus&atilde;o?
          <button type="button" class="btn btn-xs btn-danger btn-delete-asset" data-dismiss="modal">Sim</button>
          <button type="button" class="btn btn-xs btn-primary" data-dismiss="modal">N&atilde;o</button>
        </div>
      </div>
    </div>
  </div>


<script>

  function toggle(source, element) {
    checkboxes = document.getElementsByName(element);
    for(var i=0, n=checkboxes.length;i<n;i++) {
      checkboxes[i].checked = source.checked;
    }
  }

  $(function() {
    // Delete selected findings
    $("a.btn-delete-selected").on('click', function(eventObject) {
      findings_to_delete = []
      $("input[name='finding']").each(function(cbx){
        if (this.checked) {
          findings_to_delete.push(this.value)
        }
      })

      if (findings_to_delete.length != 0){
        delete_url="{% url 'delete_findings_api' %}"
        var request = $.ajax({
          url: delete_url,
          method: "POST",
          headers: {"X-CSRFToken": "{{ csrf_token }}"},
          data: JSON.stringify(findings_to_delete),
          contentType: "application/json"
        });
        request.done(function(response){
          if (response.status == 'success'){location.reload()}
        });
      }
    });

    // Compare findings
    $("a.btn-compare-selected").on('click', function (e) {
      findings_to_compare = [];
      $("input[name='finding']").each(function(cbx){
        if (this.checked) {
          findings_to_compare.push(this.value);
        }
      });
      if(findings_to_compare.length == 2){
        window.location.href ="/findings/compare?finding_a_id="+findings_to_compare[0]+"&finding_b_id="+findings_to_compare[1];
      }
    });

    // Change the finding status
    $("a.btn-ack").on('click', function(eventObject) {
      findings_to_ack = [];
      $("input[name='finding']").each(function(cbx){
        if (this.checked) {
          findings_to_ack.push({'ack': this.value});
        }
      })

      if (findings_to_ack.length != 0){
        ack_url="{% url 'change_findings_status_api' %}";
        var request = $.ajax({
          url: ack_url,
          method: "POST",
          headers: {"X-CSRFToken": "{{ csrf_token }}"},
          data: JSON.stringify(findings_to_ack),
          contentType: "application/json"
        });
        request.done(function(response){
          if (response.status == 'success'){
            location.reload();
          }
        });
      }
    });

    // Delete tag
    $("i.delete-tag-btn").on('click', function(eventObject) {
      del_url="/assets/api/v1/groups/details/{{asset_group.id|safe}}/del_tag"
      tag_id = eventObject.currentTarget.getAttribute('tag-id');
      var request = $.ajax({
        url: del_url,
        method: "POST",
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        data: "tag_id="+tag_id,
        success: function(data, textStatus, xhr){
          location.reload();
        }
      });
    });

    // Autocomplete tags modal searchbar
    $("#input-search-tags").autocomplete({
      source: function(req, response) {
         $.ajax({
          // url: "/assets/get_tags",
          url: "{% url 'get_asset_tags_api' %}",
          dataType: "json",
          success: function( data ) {
            var re = $.ui.autocomplete.escapeRegex(req.term);
            var matcher = new RegExp(re, "i" ); //Start with
            response($.grep(data, function(item){return matcher.test(item.value || item.label || item);}) );
            }
          });
       },
      minLength: 2,
      appendTo: ".search-asset-group-tags-form",
      autoFocus: true
    });

    // Delete asset modal
    $("#modal-delete-asset").on('show.bs.modal', function (e) {
      id = e.relatedTarget.getAttribute('asset-id');
      asset_value = e.relatedTarget.getAttribute('asset-value');
      $("div#delete-asset").attr('asset-id', id);
      $("div#delete-asset").html("Asset: <b>"+asset_value+"</b><br/><br/>");
    });
    $("button.btn-delete-asset").on('click', function (e) {
      id = $("div#delete-asset").attr('asset-id');
      delete_asset_url = "{% url 'delete_asset_api' 0 %}".replace("0", id);
      var request = $.ajax({
        url: delete_asset_url,
        method: "POST",
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        success: function(){
          location.reload();
        }
      });
    });

    // Delete finding modal
    $("#modal-delete-finding").on('show.bs.modal', function (e) {
      finding_id = e.relatedTarget.getAttribute('finding-id');
      finding_title = e.relatedTarget.getAttribute('finding-title');
      $("div#delete-finding").attr('finding-id', finding_id);
      $("div#delete-finding").html("Finding: <b>"+finding_title+"</b><br/><br/>");
    });
    $("button.btn-delete-finding").on('click', function (e) {
      finding_id = $("div#delete-finding").attr('finding-id');
      delete_finding_url = "/findings/delete/"+finding_id;
      var request = $.ajax({
        url: delete_finding_url,
        method: "POST",
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        success: function(){
          location.reload();
        }
      });
    });

    // Fixing bootstrap tab issue
    $('#menu_tabs_ul > li > a').click(function(e) {
      $(this).removeClass('active');
    });

  });
</script>


{% endblock %}
